<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
        }
        
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: rgba(155, 155, 155, 0.3) transparent;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(155, 155, 155, 0.3);
            border-radius: 20px;
        }
        
        .tab {
            transition: all 0.15s ease;
        }
        
        .tab:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .message-animate {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        textarea:focus {
            outline: none;
        }
        
        .model-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25rem;
            padding-right: 2rem;
            min-width: 220px;
        }
        
        .recording-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typingAnimation 1.4s infinite;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-8px);
            }
        }
        
        .file-input {
            display: none;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            animation: fadeIn 0.2s ease;
        }
        
        .sidebar-mobile {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            z-index: 50;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        @media (max-width: 768px) {
            .tab:hover {
                background-color: transparent;
            }
            
            .tab.active {
                background-color: white;
            }
        }
        
        .profile-modal {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            max-width: 480px;
            background: white;
            z-index: 60;
            animation: slideInRight 0.3s ease;
            overflow-y: auto;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .profile-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 400;
            margin: 2px;
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .profile-section {
            transition: all 0.2s ease;
        }
        
        .profile-tabs-container {
            position: relative;
        }
        
        .profile-tabs {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }
        
        .profile-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .scroll-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40px;
            pointer-events: none;
            z-index: 10;
        }
        
        .scroll-indicator-left {
            left: 0;
            background: linear-gradient(to right, white, transparent);
        }
        
        .scroll-indicator-right {
            right: 0;
            background: linear-gradient(to left, white, transparent);
        }
        
        .profile-tab-content {
            animation: fadeIn 0.3s ease;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .auth-button {
            width: 100%;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .auth-button:active {
            transform: translateY(0);
        }
        
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 24px 0;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .divider span {
            padding: 0 16px;
            color: #9ca3af;
            font-size: 13px;
        }
        
        .token-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        @media (max-width: 640px) {
            .login-card {
                padding: 30px 24px;
            }
        }
        
        /* Markdown styles */
        .markdown-content {
            word-wrap: break-word;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4 {
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.3em; }
        .markdown-content h3 { font-size: 1.1em; }
        
        .markdown-content p {
            margin-bottom: 0.75em;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }
        
        .markdown-content li {
            margin-bottom: 0.25em;
        }
        
        .markdown-content code {
            background: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .markdown-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.75em 0;
        }
        
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        
        .markdown-content blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1rem;
            color: #6b7280;
            margin: 0.75em 0;
        }
        
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.75em 0;
        }
        
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .markdown-content th {
            background: #f9fafb;
            font-weight: 600;
        }
        
        .markdown-content strong {
            font-weight: 600;
        }
        
        .markdown-content em {
            font-style: italic;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5em 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Настройка marked для правильного рендеринга markdown
        marked.setOptions({
            breaks: true,
            gfm: true,
            sanitize: false
        });

        // Вынесем ProfileSection наружу, чтобы избежать пересоздания при каждом рендере
        const ProfileSection = ({ title, items, color, field, isEditing, newItemInput, updateNewItemInput, addItemToProfileArray, removeItemFromProfileArray }) => (
            <div className="profile-section mb-4">
                <h3 className="text-xs font-medium text-gray-600 mb-1.5">{title}</h3>
                {isEditing ? (
                    <div>
                        <div className="flex flex-wrap gap-1.5 mb-2">
                            {items.map((item, index) => (
                                <span key={index} className="profile-badge flex items-center gap-2">
                                    {item}
                                    <button
                                        onClick={() => removeItemFromProfileArray(field, index)}
                                        className="text-gray-400 hover:text-gray-600"
                                    >
                                        ✕
                                    </button>
                                </span>
                            ))}
                        </div>
                            <div className="flex gap-2">
                                <input
                                    key={`input-${field}`}
                                    type="text"
                                    value={newItemInput[field] || ''}
                                    onChange={(e) => updateNewItemInput(field, e.target.value)}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            addItemToProfileArray(field);
                                        }
                                    }}
                                    placeholder="Добавить..."
                                    className="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                    autoComplete="off"
                                />
                                <button
                                    onClick={() => addItemToProfileArray(field)}
                                    className="px-3 py-1.5 bg-gray-900 text-white rounded-md text-sm hover:bg-gray-800 transition-colors"
                                >
                                    +
                                </button>
                            </div>
                    </div>
                ) : (
                        <div className="flex flex-wrap gap-1.5">
                            {items.map((item, index) => (
                                <span key={index} className="profile-badge">
                                    {item}
                                </span>
                            ))}
                            {items.length === 0 && (
                                <span className="text-xs text-gray-400 italic">Пока нет данных</span>
                            )}
                        </div>
                    )}
            </div>
        );

        function App() {
            const [models, setModels] = useState([]);
            const [isLoadingModels, setIsLoadingModels] = useState(true);
            
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [user, setUser] = useState(null);
            const [tokenBalance, setTokenBalance] = useState(10000);
            const [showEmailLogin, setShowEmailLogin] = useState(false);
            const [isRegisterMode, setIsRegisterMode] = useState(false);
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [authLoading, setAuthLoading] = useState(false);
            const [authError, setAuthError] = useState('');
            
            const [tabs, setTabs] = useState([]);
            const [activeTabId, setActiveTabId] = useState(null);
            const [isLoadingChats, setIsLoadingChats] = useState(false);
            const [input, setInput] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [attachedFiles, setAttachedFiles] = useState([]);
            const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
            const [isProfileOpen, setIsProfileOpen] = useState(false);
            const [activeProfileTab, setActiveProfileTab] = useState('personal');
            const [isEditingProfile, setIsEditingProfile] = useState(false);
            const [editedProfile, setEditedProfile] = useState(null);
            const [newItemInput, setNewItemInput] = useState({});
            const [deleteConfirmModal, setDeleteConfirmModal] = useState({ isOpen: false, chatId: null, chatName: '' });
            const [isDeletingChat, setIsDeletingChat] = useState(false);
            const [userProfile, setUserProfile] = useState({
                // Личное
                likes: ['Программирование', 'Путешествия', 'Чтение'],
                dislikes: ['Спешка', 'Беспорядок'],
                interests: ['Искусственный интеллект', 'Веб-разработка', 'Дизайн'],
                desires: ['Создать успешный проект', 'Улучшить навыки'],
                intentions: ['Научиться новым технологиям', 'Развиваться профессионально'],
                values: ['Качество', 'Простота', 'Эффективность'],
                beliefs: ['Постоянное обучение важно', 'Качество важнее количества'],
                skills: ['JavaScript', 'React', 'Python', 'UI/UX дизайн'],
                hobbies: ['Чтение', 'Программирование', 'Путешествия'],
                
                // Профессиональное
                occupation: 'Разработчик',
                experienceLevel: 'Средний',
                industry: 'IT / Технологии',
                currentProjects: ['Веб-приложение', 'AI чат-бот'],
                learningGoals: ['Изучить новые фреймворки', 'Улучшить навыки дизайна'],
                
                // Коммуникация
                communicationStyle: 'Сбалансированный',
                detailLevel: 'Средний',
                technicalDepth: 'Средний',
                languagePreference: 'Русский',
                tonePreference: 'Дружеский',
                
                // Контекст
                painPoints: ['Нехватка времени', 'Сложность в организации'],
                motivations: ['Создать качественный продукт', 'Постоянно учиться'],
                challenges: ['Баланс работы и жизни', 'Управление временем'],
                strengths: ['Быстрое обучение', 'Внимание к деталям'],
                
                // Цели
                shortTermGoals: ['Завершить текущий проект', 'Изучить новую технологию'],
                longTermGoals: ['Стать senior разработчиком', 'Запустить свой продукт'],
                
                // Социальные
                relationshipStatus: 'Не указано',
                family: 'Не указано',
                socialPreferences: ['Небольшие компании', 'Глубокие разговоры'],
                
                // Здоровье и благополучие
                healthGoals: ['Улучшить физическую форму', 'Больше спать'],
                dietaryPreferences: ['Здоровое питание', 'Умеренность'],
                exerciseHabits: ['Прогулки', 'Йога'],
                stressLevel: 'Средний',
                energyLevel: 'Средний',
                
                // Другое (для каждой категории)
                personalOther: [],
                professionalOther: [],
                communicationOther: [],
                goalsOther: [],
                socialOther: [],
                healthOther: []
            });
            const messagesEndRef = useRef(null);
            const textareaRef = useRef(null);
            const fileInputRef = useRef(null);
            const mediaRecorderRef = useRef(null);

            const activeTab = tabs.find(tab => tab.id === activeTabId);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            // Проверка сохраненной сессии при загрузке
            useEffect(() => {
                const savedUserId = localStorage.getItem('user_id');
                const savedUserData = localStorage.getItem('user_data');
                
                if (savedUserId && savedUserData) {
                    try {
                        const userData = JSON.parse(savedUserData);
                        setUser(userData);
                        setIsAuthenticated(true);
                    } catch (error) {
                        console.error('Ошибка восстановления сессии:', error);
                        localStorage.removeItem('user_id');
                        localStorage.removeItem('user_data');
                    }
                }
            }, []);

            // Загрузка чатов после авторизации
            useEffect(() => {
                if (isAuthenticated && user && models.length > 0) {
                    loadChats();
                }
            }, [isAuthenticated, user, models]);

            // Загрузка истории сообщений при переключении чата
            useEffect(() => {
                if (activeTabId && activeTab && activeTab.chat_id && !activeTab.isMessagesLoaded) {
                    loadChatMessages(activeTab.chat_id);
                }
            }, [activeTabId]);
            
            // Загрузка списка моделей при монтировании компонента
            useEffect(() => {
                const loadModels = async () => {
                    try {
                        setIsLoadingModels(true);
                        const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/get_llm', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Ошибка загрузки моделей');
                        }
                        
                        const data = await response.json();
                        
                        // Проверяем, что получили массив с моделями
                        if (!data || data.length === 0) {
                            throw new Error('Получен пустой список моделей');
                        }
                        
                        setModels(data);
                    } catch (error) {
                        console.error('Ошибка загрузки моделей:', error);
                        // Fallback на дефолтные модели в случае ошибки
                        const fallbackModels = [
                            { id: 1, name: 'GPT-4', type: 'openrouter' },
                            { id: 2, name: 'Claude Sonnet', type: 'openrouter' }
                        ];
                        setModels(fallbackModels);
                    } finally {
                        setIsLoadingModels(false);
                    }
                };
                
                loadModels();
            }, []);

            useEffect(() => {
                scrollToBottom();
            }, [activeTab?.messages]);

            const addNewTab = async () => {
                if (!user || !user.email) return;
                
                try {
                    // Создаем чат на сервере
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/create_chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: user.email,
                            model_id: models[0]?.id || 1,
                            name: 'Новый чат'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Ошибка создания чата');
                    }
                    
                    // Добавляем новую вкладку с chat_id из БД
                    const newId = tabs.length > 0 ? Math.max(...tabs.map(t => t.id)) + 1 : 1;
                    const newTab = { 
                        id: newId,
                        chat_id: data.chat.id, // ID из БД
                        name: data.chat.name, 
                        messages: [],
                        model: data.chat.model_id,
                        message_count: 0,
                        isMessagesLoaded: true // Новый чат пустой, не нужно загружать
                    };
                    
                    setTabs([newTab, ...tabs]);
                    setActiveTabId(newId);
                    setIsMobileSidebarOpen(false);
                } catch (error) {
                    console.error('Ошибка создания чата:', error);
                    alert('Не удалось создать чат');
                }
            };

            const closeTab = (tabId, e) => {
                e.stopPropagation();
                const chatToDelete = tabs.find(tab => tab.id === tabId);
                if (!chatToDelete) return;
                
                // Открываем модальное окно подтверждения
                setDeleteConfirmModal({
                    isOpen: true,
                    chatId: chatToDelete.chat_id || tabId, // используем chat_id из БД
                    chatName: chatToDelete.name,
                    localId: tabId // сохраняем локальный ID для UI обновления
                });
            };
            
            const confirmDeleteChat = async () => {
                const { chatId, localId } = deleteConfirmModal;
                setIsDeletingChat(true);
                
                try {
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/delete_chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: user.email,
                            chat_id: chatId
                        }),
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Удаляем чат из локального состояния
                        const newTabs = tabs.filter(tab => tab.id !== localId);
                        setTabs(newTabs);
                        
                        // Если удален активный чат, переключаемся на первый доступный
                        if (activeTabId === localId && newTabs.length > 0) {
                            setActiveTabId(newTabs[0].id);
                        } else if (newTabs.length === 0) {
                            setActiveTabId(null);
                        }
                    } else {
                        alert('Ошибка удаления чата: ' + (data.error || 'Неизвестная ошибка'));
                    }
                } catch (error) {
                    console.error('Ошибка при удалении чата:', error);
                    alert('Не удалось удалить чат. Проверьте подключение к интернету.');
                } finally {
                    setIsDeletingChat(false);
                    setDeleteConfirmModal({ isOpen: false, chatId: null, chatName: '', localId: null });
                }
            };
            
            const cancelDeleteChat = () => {
                setDeleteConfirmModal({ isOpen: false, chatId: null, chatName: '', localId: null });
            };

            const handleLogin = async (provider) => {
                setAuthError('');
                
                // Для социальных провайдеров (пока симуляция)
                if (provider !== 'email') {
                    const userData = {
                        name: 'Пользователь',
                        email: `user@${provider}.com`,
                        provider: provider,
                        avatar: provider.charAt(0).toUpperCase()
                    };
                    setUser(userData);
                    setIsAuthenticated(true);
                    return;
                }
                
                // Валидация для email логина
                if (!email || !password) {
                    setAuthError('Пожалуйста, заполните все поля');
                    return;
                }
                
                try {
                    setAuthLoading(true);
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Ошибка входа');
                    }
                    
                    // Успешный логин
                    const userData = {
                        id: data.id,
                        name: data.name,
                        email: data.email,
                        provider: 'email',
                        avatar: data.name.charAt(0).toUpperCase()
                    };
                    
                    // Сохраняем user_id в localStorage
                    localStorage.setItem('user_id', data.id);
                    localStorage.setItem('user_data', JSON.stringify(userData));
                    
                    setUser(userData);
                    setIsAuthenticated(true);
                    setShowEmailLogin(false);
                    setTokenBalance(data.token_balance || 10000);
                    
                    // Очистка полей
                    setEmail('');
                    setPassword('');
                } catch (error) {
                    console.error('Ошибка логина:', error);
                    setAuthError(error.message || 'Неверный email или пароль');
                } finally {
                    setAuthLoading(false);
                }
            };

            const handleRegister = async () => {
                setAuthError('');
                
                // Валидация
                if (!name || !email || !password || !confirmPassword) {
                    setAuthError('Пожалуйста, заполните все поля');
                    return;
                }
                if (password !== confirmPassword) {
                    setAuthError('Пароли не совпадают');
                    return;
                }
                if (password.length < 6) {
                    setAuthError('Пароль должен содержать минимум 6 символов');
                    return;
                }
                
                try {
                    setAuthLoading(true);
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            email: email,
                            password: password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Ошибка регистрации');
                    }
                    
                    // Успешная регистрация
                    const userData = {
                        id: data.id,
                        name: data.name,
                        email: data.email,
                        provider: 'email',
                        avatar: data.name.charAt(0).toUpperCase()
                    };
                    
                    // Сохраняем user_id в localStorage
                    localStorage.setItem('user_id', data.id);
                    localStorage.setItem('user_data', JSON.stringify(userData));
                    
                    setUser(userData);
                    setIsAuthenticated(true);
                    setShowEmailLogin(false);
                    setIsRegisterMode(false);
                    setTokenBalance(data.token_balance || 10000);
                    
                    // Очистка полей
                    setName('');
                    setEmail('');
                    setPassword('');
                    setConfirmPassword('');
                } catch (error) {
                    console.error('Ошибка регистрации:', error);
                    setAuthError(error.message || 'Не удалось зарегистрироваться. Возможно, такой email уже используется');
                } finally {
                    setAuthLoading(false);
                }
            };

            const handleLogout = () => {
                // Очищаем localStorage
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_data');
                
                setIsAuthenticated(false);
                setUser(null);
                setTabs([]);
                setActiveTabId(null);
            };

            // Загрузка чатов пользователя
            const loadChats = async () => {
                if (!user || !user.email) return;
                
                try {
                    setIsLoadingChats(true);
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/get_chats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: user.email
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Ошибка загрузки чатов');
                    }
                    
                    // Преобразуем чаты из БД в формат для state
                    const loadedTabs = data.chats.map((chat, index) => ({
                        id: index + 1, // Локальный ID для UI
                        chat_id: chat.id, // ID из БД
                        name: chat.name,
                        messages: [], // Сообщения загрузятся при открытии чата
                        model: chat.model_id,
                        message_count: chat.message_count,
                        isMessagesLoaded: false // Флаг загрузки сообщений
                    }));
                    
                    setTabs(loadedTabs);
                    
                    // Если есть чаты, открываем первый
                    if (loadedTabs.length > 0) {
                        setActiveTabId(loadedTabs[0].id);
                    }
                } catch (error) {
                    console.error('Ошибка загрузки чатов:', error);
                } finally {
                    setIsLoadingChats(false);
                }
            };

            // Загрузка истории сообщений для чата
            const loadChatMessages = async (chatId) => {
                if (!user || !user.email || !chatId) return;
                
                try {
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/get_messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: user.email,
                            chat_id: chatId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Ошибка загрузки сообщений');
                    }
                    
                    // Обновляем сообщения для этого чата
                    setTabs(prevTabs => prevTabs.map(tab => {
                        if (tab.chat_id === chatId) {
                            const modelName = models.find(m => m.id === tab.model)?.name || '';
                            return {
                                ...tab,
                                messages: data.messages.map(msg => ({
                                    role: msg.role,
                                    content: msg.content,
                                    files: msg.files || [],
                                    // Для сообщений ассистента сохраняем модель чата
                                    ...(msg.role === 'assistant' && {
                                        model: tab.model,
                                        modelName: modelName
                                    })
                                })),
                                isMessagesLoaded: true
                            };
                        }
                        return tab;
                    }));
                    
                } catch (error) {
                    console.error('Ошибка загрузки истории сообщений:', error);
                }
            };

            const handleDeleteAccount = async () => {
                if (!confirm('Вы уверены, что хотите удалить аккаунт? Все данные будут безвозвратно удалены.')) {
                    return;
                }
                
                try {
                    // Отправляем запрос на удаление аккаунта
                    await fetch('https://nomira-ai-test.up.railway.app/webhook/delete_account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: user.id
                        })
                    });
                } catch (error) {
                    console.error('Ошибка удаления аккаунта:', error);
                }
                
                // Очищаем localStorage и состояние
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_data');
                
                setIsAuthenticated(false);
                setUser(null);
                setTabs([{ id: 1, name: 'Новый чат', messages: [], model: models[0]?.id || 1 }]);
                setActiveTabId(1);
                setUserProfile({
                    likes: [],
                    dislikes: [],
                    interests: [],
                    desires: [],
                    intentions: [],
                    values: [],
                    beliefs: [],
                    skills: [],
                    hobbies: [],
                    occupation: '',
                    experienceLevel: '',
                    industry: '',
                    currentProjects: [],
                    learningGoals: [],
                    communicationStyle: '',
                    detailLevel: '',
                    technicalDepth: '',
                    languagePreference: '',
                    tonePreference: '',
                    painPoints: [],
                    motivations: [],
                    challenges: [],
                    strengths: [],
                    shortTermGoals: [],
                    longTermGoals: [],
                    relationshipStatus: '',
                    family: '',
                    socialPreferences: [],
                    healthGoals: [],
                    dietaryPreferences: [],
                    exerciseHabits: [],
                    stressLevel: '',
                    energyLevel: '',
                    personalOther: [],
                    professionalOther: [],
                    communicationOther: [],
                    goalsOther: [],
                    socialOther: [],
                    healthOther: []
                });
                setTokenBalance(10000);
                alert('Аккаунт успешно удален');
            };

            const sendMessage = async () => {
                if (!input.trim() && attachedFiles.length === 0) return;
                if (!activeTab || !activeTab.chat_id) {
                    alert('Ошибка: чат не инициализирован');
                    return;
                }

                // Очищаем поле ввода сразу
                const messageText = input;
                const messageFiles = [...attachedFiles];
                setInput('');
                setAttachedFiles([]);
                
                const userMessage = { 
                    role: 'user', 
                    content: messageText,
                    files: messageFiles
                };
                
                // Получаем текущую модель
                const currentModel = activeTab.model;
                const modelName = models.find(m => m.id === currentModel)?.name || '';
                
                // Добавляем сообщение пользователя и пустое сообщение ассистента с индикатором печатания
                let assistantMessageIndex;
                setTabs(prevTabs => prevTabs.map(tab => {
                    if (tab.id === activeTabId) {
                        const newMessages = [
                            ...tab.messages, 
                            userMessage,
                            { role: 'assistant', content: '', model: currentModel, modelName: modelName, isTyping: true }
                        ];
                        assistantMessageIndex = newMessages.length - 1; // Индекс последнего сообщения (ассистент)
                        
                        return { 
                            ...tab, 
                            messages: newMessages,
                            name: tab.messages.length === 0 
                                ? (messageText || 'Файлы').slice(0, 30) + (messageText.length > 30 ? '...' : '')
                                : tab.name,
                            isMessagesLoaded: true
                        };
                    }
                    return tab;
                }));
                
                // Симуляция обновления профиля
                simulateProfileUpdate(messageText);
                
                try {
                    const response = await fetch('https://nomira-ai-test.up.railway.app/webhook/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: user.email,
                            chat_id: activeTab.chat_id,
                            model: modelName,
                            message: messageText
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка отправки сообщения');
                    }
                    
                    // Читаем streaming ответ
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let accumulatedContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (!line.trim()) continue;
                            
                            try {
                                const data = JSON.parse(line);
                                
                                if (data.type === 'item' && data.content) {
                                    accumulatedContent += data.content;
                                    
                                    // Обновляем сообщение ассистента в реальном времени
                                    setTabs(prevTabs => prevTabs.map(t => {
                                        if (t.id === activeTabId) {
                                            const newMessages = [...t.messages];
                                            const lastIndex = newMessages.length - 1;
                                            newMessages[lastIndex] = {
                                                role: 'assistant',
                                                content: accumulatedContent,
                                                model: currentModel,
                                                modelName: modelName,
                                                isTyping: false // Убираем индикатор печатания когда начинают поступать данные
                                            };
                                            return { ...t, messages: newMessages };
                                        }
                                        return t;
                                    }));
                                }
                            } catch (e) {
                                // Игнорируем ошибки парсинга неполных JSON
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('Ошибка отправки сообщения:', error);
                    
                    // Обновляем последнее сообщение ассистента с ошибкой
                    setTabs(prevTabs => prevTabs.map(t => {
                        if (t.id === activeTabId) {
                            const newMessages = [...t.messages];
                            const lastIndex = newMessages.length - 1;
                            newMessages[lastIndex] = {
                                role: 'assistant',
                                content: `Ошибка: ${error.message}. Попробуйте еще раз.`,
                                model: currentModel,
                                modelName: modelName,
                                isTyping: false
                            };
                            return { ...t, messages: newMessages };
                        }
                        return t;
                    }));
                }
            };

            const simulateProfileUpdate = (message) => {
                // Простая симуляция извлечения информации из сообщения
                const lowerMessage = message.toLowerCase();
                
                // Примеры ключевых слов для обновления профиля
                if (lowerMessage.includes('люблю') || lowerMessage.includes('нравится')) {
                    const keywords = ['кофе', 'музыка', 'спорт', 'кино', 'книги', 'природа'];
                    keywords.forEach(keyword => {
                        if (lowerMessage.includes(keyword) && !userProfile.likes.includes(keyword.charAt(0).toUpperCase() + keyword.slice(1))) {
                            setUserProfile(prev => ({
                                ...prev,
                                likes: [...prev.likes, keyword.charAt(0).toUpperCase() + keyword.slice(1)]
                            }));
                        }
                    });
                }
                
                if (lowerMessage.includes('не люблю') || lowerMessage.includes('не нравится')) {
                    const keywords = ['шум', 'толпа', 'жара', 'холод'];
                    keywords.forEach(keyword => {
                        if (lowerMessage.includes(keyword) && !userProfile.dislikes.includes(keyword.charAt(0).toUpperCase() + keyword.slice(1))) {
                            setUserProfile(prev => ({
                                ...prev,
                                dislikes: [...prev.dislikes, keyword.charAt(0).toUpperCase() + keyword.slice(1)]
                            }));
                        }
                    });
                }
                
                if (lowerMessage.includes('хочу') || lowerMessage.includes('мечтаю')) {
                    const keywords = ['путешествовать', 'учиться', 'развиваться', 'создать'];
                    keywords.forEach(keyword => {
                        if (lowerMessage.includes(keyword)) {
                            const desire = keyword.charAt(0).toUpperCase() + keyword.slice(1);
                            if (!userProfile.desires.some(d => d.toLowerCase().includes(keyword))) {
                                setUserProfile(prev => ({
                                    ...prev,
                                    desires: [...prev.desires, desire]
                                }));
                            }
                        }
                    });
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const handleInputChange = (e) => {
                setInput(e.target.value);
                // Автоматическое изменение высоты
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
                }
            };

            useEffect(() => {
                // Сброс высоты при очистке input
                const textarea = textareaRef.current;
                if (textarea && !input) {
                    textarea.style.height = 'auto';
                }
            }, [input]);

            const changeModel = (modelId) => {
                // Преобразуем в число, так как value из select приходит как строка
                const numericModelId = parseInt(modelId, 10);
                setTabs(tabs.map(tab => 
                    tab.id === activeTabId ? { ...tab, model: numericModelId } : tab
                ));
            };

            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                const fileObjects = files.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    url: URL.createObjectURL(file)
                }));
                setAttachedFiles(prev => [...prev, ...fileObjects]);
            };

            const removeFile = (index) => {
                setAttachedFiles(prev => prev.filter((_, i) => i !== index));
            };

            const startEditingProfile = () => {
                setEditedProfile(JSON.parse(JSON.stringify(userProfile)));
                setIsEditingProfile(true);
            };

            const cancelEditingProfile = () => {
                setEditedProfile(null);
                setIsEditingProfile(false);
                setNewItemInput({});
            };

            const saveProfile = () => {
                setUserProfile(editedProfile);
                setIsEditingProfile(false);
                setEditedProfile(null);
                setNewItemInput({});
                // Можно добавить уведомление об успешном сохранении
                // alert('Профиль успешно обновлен');
            };

            const updateProfileField = (field, value) => {
                setEditedProfile(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const addItemToProfileArray = (field) => {
                const value = newItemInput[field] || '';
                if (value.trim()) {
                    setEditedProfile(prev => ({
                        ...prev,
                        [field]: [...prev[field], value.trim()]
                    }));
                    setNewItemInput(prev => ({ ...prev, [field]: '' }));
                }
            };

            const updateNewItemInput = (field, value) => {
                setNewItemInput(prev => ({ ...prev, [field]: value }));
            };

            const removeItemFromProfileArray = (field, index) => {
                setEditedProfile(prev => ({
                    ...prev,
                    [field]: prev[field].filter((_, i) => i !== index)
                }));
            };

            const toggleRecording = async () => {
                if (isRecording) {
                    // Остановить запись
                    mediaRecorderRef.current?.stop();
                    setIsRecording(false);
                } else {
                    // Начать запись
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mediaRecorder = new MediaRecorder(stream);
                        const audioChunks = [];

                        mediaRecorder.ondataavailable = (event) => {
                            audioChunks.push(event.data);
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audioFile = {
                                name: `Голосовое сообщение ${new Date().toLocaleTimeString()}`,
                                size: audioBlob.size,
                                type: 'audio/webm',
                                url: audioUrl,
                                isAudio: true
                            };
                            setAttachedFiles(prev => [...prev, audioFile]);
                            stream.getTracks().forEach(track => track.stop());
                        };

                        mediaRecorder.start();
                        mediaRecorderRef.current = mediaRecorder;
                        setIsRecording(true);
                    } catch (err) {
                        alert('Не удалось получить доступ к микрофону');
                    }
                }
            };

            // Экран загрузки моделей
            if (isLoadingModels) {
                return (
                    <div className="flex items-center justify-center h-screen bg-white">
                        <div className="text-center">
                            <div className="inline-block w-12 h-12 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin mb-4"></div>
                            <p className="text-gray-600 text-sm">Загрузка моделей...</p>
                        </div>
                    </div>
                );
            }

            // Страница логина
            if (!isAuthenticated) {
                return (
                    <div className="login-container">
                        <div className="login-card">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">AI Chat</h1>
                                <p className="text-gray-500">Войдите, чтобы начать общение</p>
                            </div>

                            {!showEmailLogin ? (
                                <div className="space-y-3">
                                    <button
                                        disabled
                                        className="auth-button opacity-50 cursor-not-allowed"
                                        title="Временно недоступно"
                                    >
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                        <span>Войти через Google</span>
                                    </button>

                                    <button
                                        disabled
                                        className="auth-button opacity-50 cursor-not-allowed"
                                        title="Временно недоступно"
                                    >
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path fill="#FF0000" d="M13.5 2h-3C7.5 2 6 3.5 6 6.5v11C6 20.5 7.5 22 10.5 22h3c3 0 4.5-1.5 4.5-4.5v-11C18 3.5 16.5 2 13.5 2zm-1.5 16h-1V7.5c0-.3.2-.5.5-.5h1c.3 0 .5.2.5.5V18z"/>
                                        </svg>
                                        <span>Войти через Яндекс ID</span>
                                    </button>

                                    <button
                                        disabled
                                        className="auth-button opacity-50 cursor-not-allowed"
                                        title="Временно недоступно"
                                    >
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path fill="#0077FF" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 12.5c.4.4 1 .9 1 1.5 0 .5-.5.5-.7.5h-1.5c-.5 0-.7-.3-.9-.5-.3-.3-.5-.6-.8-.9-.5-.5-.7-.6-1-.6-.4 0-.5.1-.5.5v1c0 .3-.1.5-.7.5-1.3 0-2.7-.8-3.7-2.2-1.5-2-2-3.5-2-3.8 0-.2.1-.4.5-.4h1.5c.4 0 .5.2.6.4.5 1.5 1.4 2.8 1.8 2.8.1 0 .2 0 .2-.3v-2c0-.5-.3-.8-.6-.8.2-.3.5-.5 1-.5h2.2c.4 0 .5.2.5.5v2.7c0 .4.2.5.3.5.2 0 .4-.1.8-.5.9-1 1.5-2.5 1.5-2.5.1-.2.3-.4.6-.4h1.5c.5 0 .6.2.5.5-.2.9-1.8 2.8-1.8 2.8-.2.2-.2.3 0 .6z"/>
                                        </svg>
                                        <span>Войти через VK</span>
                                    </button>

                                    <div className="divider">
                                        <span>или</span>
                                    </div>

                                    <button
                                        onClick={() => setShowEmailLogin(true)}
                                        className="auth-button"
                                        style={{ borderColor: '#667eea', color: '#667eea' }}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                        <span>Войти через Email</span>
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <div className="mb-4">
                                        <h2 className="text-xl font-semibold text-gray-800 text-center">
                                            {isRegisterMode ? 'Регистрация' : 'Вход'}
                                        </h2>
                                    </div>
                                    
                                    {authError && (
                                        <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                            {authError}
                                        </div>
                                    )}
                                    
                                    <div className="space-y-4 mb-4">
                                        {isRegisterMode && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Имя</label>
                                                <input
                                                    type="text"
                                                    value={name}
                                                    onChange={(e) => {
                                                        setName(e.target.value);
                                                        setAuthError('');
                                                    }}
                                                    placeholder="Ваше имя"
                                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors"
                                                    disabled={authLoading}
                                                />
                                            </div>
                                        )}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                            <input
                                                type="email"
                                                value={email}
                                                onChange={(e) => {
                                                    setEmail(e.target.value);
                                                    setAuthError('');
                                                }}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter' && !isRegisterMode) {
                                                        handleLogin('email');
                                                    }
                                                }}
                                                placeholder="your@email.com"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors"
                                                disabled={authLoading}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Пароль</label>
                                            <input
                                                type="password"
                                                value={password}
                                                onChange={(e) => {
                                                    setPassword(e.target.value);
                                                    setAuthError('');
                                                }}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter' && !isRegisterMode) {
                                                        handleLogin('email');
                                                    }
                                                }}
                                                placeholder="••••••••"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors"
                                                disabled={authLoading}
                                            />
                                        </div>
                                        {isRegisterMode && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Подтвердите пароль</label>
                                                <input
                                                    type="password"
                                                    value={confirmPassword}
                                                    onChange={(e) => {
                                                        setConfirmPassword(e.target.value);
                                                        setAuthError('');
                                                    }}
                                                    onKeyPress={(e) => {
                                                        if (e.key === 'Enter') {
                                                            handleRegister();
                                                        }
                                                    }}
                                                    placeholder="••••••••"
                                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors"
                                                    disabled={authLoading}
                                                />
                                            </div>
                                        )}
                                    </div>
                                    
                                    <button
                                        onClick={isRegisterMode ? handleRegister : () => handleLogin('email')}
                                        disabled={authLoading || (isRegisterMode 
                                            ? !name || !email || !password || !confirmPassword
                                            : !email || !password)
                                        }
                                        className="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        {authLoading && (
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                        )}
                                        {authLoading 
                                            ? (isRegisterMode ? 'Регистрация...' : 'Вход...') 
                                            : (isRegisterMode ? 'Зарегистрироваться' : 'Войти')
                                        }
                                    </button>
                                    
                                    <button
                                        onClick={() => setIsRegisterMode(!isRegisterMode)}
                                        className="w-full mt-3 py-3 px-4 text-purple-600 hover:text-purple-700 transition-colors font-medium"
                                    >
                                        {isRegisterMode ? 'Уже есть аккаунт? Войти' : 'Нет аккаунта? Зарегистрироваться'}
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            setShowEmailLogin(false);
                                            setIsRegisterMode(false);
                                            setName('');
                                            setEmail('');
                                            setPassword('');
                                            setConfirmPassword('');
                                            setAuthError('');
                                        }}
                                        className="w-full mt-2 py-3 px-4 text-gray-600 hover:text-gray-800 transition-colors"
                                        disabled={authLoading}
                                    >
                                        ← Назад
                                    </button>
                                </div>
                            )}
                            
                            {!showEmailLogin && (
                                <p className="text-xs text-gray-400 text-center mt-6">
                                    Нажимая "Войти", вы соглашаетесь с условиями использования
                                </p>
                            )}
                        </div>
                    </div>
                );
            }

            // Главный интерфейс чата
            return (
                <div className="flex h-screen bg-white">
                    {/* Overlay для мобильных и профиля */}
                    {(isMobileSidebarOpen || isProfileOpen) && (
                        <div 
                            className="sidebar-overlay"
                            style={{ zIndex: isProfileOpen ? 55 : 40 }}
                            onClick={() => {
                                setIsMobileSidebarOpen(false);
                                setIsProfileOpen(false);
                                setActiveProfileTab('personal');
                                cancelEditingProfile();
                            }}
                        />
                    )}

                    {/* Боковая панель с вкладками */}
                    <div className={`
                        w-64 bg-gray-50 border-r border-gray-200 flex flex-col
                        md:relative
                        ${isMobileSidebarOpen ? 'sidebar-mobile' : 'hidden md:flex'}
                    `}>
                        <div className="p-3 border-b border-gray-200">
                            <button
                                onClick={addNewTab}
                                className="w-full py-2.5 px-4 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 active:bg-gray-100 transition-colors"
                            >
                                + Новый чат
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-2">
                            {isLoadingChats ? (
                                <div className="flex items-center justify-center py-8">
                                    <div className="text-center">
                                        <div className="inline-block w-8 h-8 border-3 border-gray-300 border-t-gray-700 rounded-full animate-spin mb-2"></div>
                                        <p className="text-xs text-gray-500">Загрузка чатов...</p>
                                    </div>
                                </div>
                            ) : tabs.length === 0 ? (
                                <div className="text-center py-8 px-4">
                                    <p className="text-sm text-gray-500 mb-3">У вас пока нет чатов</p>
                                    <p className="text-xs text-gray-400">Нажмите "+ Новый чат" выше</p>
                                </div>
                            ) : (
                                tabs.map(tab => (
                                <div
                                    key={tab.id}
                                    onClick={() => {
                                        setActiveTabId(tab.id);
                                        setIsMobileSidebarOpen(false);
                                    }}
                                    className={`tab flex items-center justify-between px-3 py-3 rounded-lg cursor-pointer mb-1 group ${
                                        activeTabId === tab.id 
                                            ? 'bg-white shadow-sm active' 
                                            : 'md:hover:bg-white active:bg-white'
                                    }`}
                                >
                                    <span className="text-sm text-gray-700 truncate flex-1">
                                        {tab.name}
                                    </span>
                                    {tabs.length > 1 && (
                                        <button
                                            onClick={(e) => closeTab(tab.id, e)}
                                            className="ml-2 text-gray-400 hover:text-gray-600 active:text-gray-700 transition-opacity md:opacity-0 md:group-hover:opacity-100"
                                        >
                                            ✕
                                        </button>
                                    )}
                                </div>
                                ))
                            )}
                        </div>
                        
                        {/* Кнопка профиля */}
                        <div className="p-3 border-t border-gray-200">
                            <button
                                onClick={() => {
                                    setIsProfileOpen(true);
                                    setIsMobileSidebarOpen(false);
                                }}
                                className="w-full py-2.5 px-4 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 active:bg-gray-100 transition-colors flex items-center justify-center space-x-2"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <span>Мой профиль</span>
                            </button>
                        </div>
                    </div>

                    {/* Модальное окно профиля */}
                    {isProfileOpen && (
                        <div className="profile-modal shadow-2xl">
                            {/* Шапка профиля */}
                            <div className="sticky top-0 bg-white border-b border-gray-200 px-3 md:px-4 py-3 flex items-center justify-between z-10">
                                <h2 className="text-base font-semibold text-gray-800">Профиль</h2>
                                <div className="flex items-center gap-2">
                                        {isEditingProfile ? (
                                            <>
                                                <button
                                                    onClick={cancelEditingProfile}
                                                    className="px-2.5 py-1 text-xs text-gray-600 hover:bg-gray-100 rounded transition-colors"
                                                >
                                                    Отмена
                                                </button>
                                                <button
                                                    onClick={saveProfile}
                                                    className="px-2.5 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors"
                                                >
                                                    Сохранить
                                                </button>
                                            </>
                                        ) : (
                                            <button
                                                onClick={startEditingProfile}
                                                className="px-2.5 py-1 text-xs text-purple-600 hover:bg-purple-50 rounded transition-colors flex items-center gap-1"
                                            >
                                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                                Редактировать
                                            </button>
                                        )}
                                    <button
                                        onClick={() => {
                                            setIsProfileOpen(false);
                                            setActiveProfileTab('personal');
                                            cancelEditingProfile();
                                        }}
                                        className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            {/* Содержимое профиля */}
                            <div>
                                {/* Информация о пользователе */}
                                <div className="p-3 md:p-4 border-b border-gray-200">
                                    <div className="flex items-center space-x-3">
                                        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-lg font-bold">
                                            {user?.avatar}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <h3 className="text-base font-semibold text-gray-800 truncate">{user?.name}</h3>
                                            <p className="text-xs text-gray-500 truncate">{user?.email}</p>
                                            <div className="mt-1">
                                                <span className="inline-flex items-center gap-1 text-xs bg-purple-50 text-purple-700 px-2 py-0.5 rounded font-medium">
                                                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    {tokenBalance.toLocaleString()}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Категории профиля - сетка */}
                                <div className="p-3 md:p-4 border-b border-gray-200">
                                    <div className="grid grid-cols-3 md:grid-cols-6 gap-1.5">
                                        {[
                                            { id: 'personal', label: 'Личное', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> },
                                            { id: 'professional', label: 'Работа', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg> },
                                            { id: 'communication', label: 'Общение', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg> },
                                            { id: 'goals', label: 'Цели', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg> },
                                            { id: 'social', label: 'Соц.', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg> },
                                            { id: 'health', label: 'Здоровье', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg> }
                                        ].map(tab => (
                                            <button
                                                key={tab.id}
                                                onClick={() => setActiveProfileTab(tab.id)}
                                                className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-all text-xs ${
                                                    activeProfileTab === tab.id
                                                        ? 'bg-gray-900 text-white'
                                                        : 'bg-gray-50 text-gray-600 hover:bg-gray-100 active:bg-gray-200'
                                                }`}
                                            >
                                                {tab.icon}
                                                <span className="font-medium">{tab.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Контент вкладок */}
                                <div className="p-3 md:p-4 overflow-y-auto" style={{ maxHeight: 'calc(100vh - 280px)' }}>
                                    {activeProfileTab === 'personal' && (
                                        <div className="profile-tab-content">
                                            <ProfileSection 
                                                title="Что люблю" 
                                                items={isEditingProfile ? editedProfile.likes : userProfile.likes} 
                                                color="#10b981" 
                                                field="likes"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Что не люблю" 
                                                items={isEditingProfile ? editedProfile.dislikes : userProfile.dislikes} 
                                                color="#ef4444" 
                                                field="dislikes"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Интересы" 
                                                items={isEditingProfile ? editedProfile.interests : userProfile.interests} 
                                                color="#3b82f6" 
                                                field="interests"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Хобби" 
                                                items={isEditingProfile ? editedProfile.hobbies : userProfile.hobbies} 
                                                color="#f59e0b" 
                                                field="hobbies"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Ценности" 
                                                items={isEditingProfile ? editedProfile.values : userProfile.values} 
                                                color="#06b6d4" 
                                                field="values"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Убеждения" 
                                                items={isEditingProfile ? editedProfile.beliefs : userProfile.beliefs} 
                                                color="#6366f1" 
                                                field="beliefs"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Другое" 
                                                items={isEditingProfile ? editedProfile.personalOther : userProfile.personalOther} 
                                                color="#6b7280" 
                                                field="personalOther"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                        </div>
                                    )}

                                    {activeProfileTab === 'professional' && (
                                        <div className="profile-tab-content">
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Профессия</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.occupation}
                                                        onChange={(e) => updateProfileField('occupation', e.target.value)}
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.occupation}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Уровень опыта</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.experienceLevel}
                                                        onChange={(e) => updateProfileField('experienceLevel', e.target.value)}
                                                        placeholder="Например: Начинающий, Средний, Продвинутый"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.experienceLevel}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Отрасль</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.industry}
                                                        onChange={(e) => updateProfileField('industry', e.target.value)}
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.industry}
                                                    </div>
                                                )}
                                            </div>
                                            <ProfileSection 
                                                title="Навыки" 
                                                items={isEditingProfile ? editedProfile.skills : userProfile.skills} 
                                                color="#ec4899" 
                                                field="skills"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Текущие проекты" 
                                                items={isEditingProfile ? editedProfile.currentProjects : userProfile.currentProjects} 
                                                color="#3b82f6" 
                                                field="currentProjects"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Цели обучения" 
                                                items={isEditingProfile ? editedProfile.learningGoals : userProfile.learningGoals} 
                                                color="#8b5cf6" 
                                                field="learningGoals"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Другое" 
                                                items={isEditingProfile ? editedProfile.professionalOther : userProfile.professionalOther} 
                                                color="#6b7280" 
                                                field="professionalOther"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                        </div>
                                    )}

                                    {activeProfileTab === 'communication' && (
                                        <div className="profile-tab-content">
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Стиль общения</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.communicationStyle}
                                                        onChange={(e) => updateProfileField('communicationStyle', e.target.value)}
                                                        placeholder="Например: Формальный, Неформальный, Сбалансированный"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.communicationStyle}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Уровень детализации</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.detailLevel}
                                                        onChange={(e) => updateProfileField('detailLevel', e.target.value)}
                                                        placeholder="Например: Краткий, Средний, Подробный"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.detailLevel}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Технический уровень</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.technicalDepth}
                                                        onChange={(e) => updateProfileField('technicalDepth', e.target.value)}
                                                        placeholder="Например: Базовый, Средний, Продвинутый"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.technicalDepth}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Предпочитаемый язык</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.languagePreference}
                                                        onChange={(e) => updateProfileField('languagePreference', e.target.value)}
                                                        placeholder="Например: Русский, English, Українська"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.languagePreference}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Тон общения</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.tonePreference}
                                                        onChange={(e) => updateProfileField('tonePreference', e.target.value)}
                                                        placeholder="Например: Дружеский, Профессиональный, Мотивирующий"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.tonePreference}
                                                    </div>
                                                )}
                                            </div>
                                            <ProfileSection 
                                                title="Сильные стороны" 
                                                items={isEditingProfile ? editedProfile.strengths : userProfile.strengths} 
                                                color="#10b981" 
                                                field="strengths"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Болевые точки" 
                                                items={isEditingProfile ? editedProfile.painPoints : userProfile.painPoints} 
                                                color="#ef4444" 
                                                field="painPoints"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Другое" 
                                                items={isEditingProfile ? editedProfile.communicationOther : userProfile.communicationOther} 
                                                color="#6b7280" 
                                                field="communicationOther"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                        </div>
                                    )}

                                    {activeProfileTab === 'goals' && (
                                        <div className="profile-tab-content">
                                            <ProfileSection 
                                                title="Желания" 
                                                items={isEditingProfile ? editedProfile.desires : userProfile.desires} 
                                                color="#f59e0b" 
                                                field="desires"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Намерения" 
                                                items={isEditingProfile ? editedProfile.intentions : userProfile.intentions} 
                                                color="#8b5cf6" 
                                                field="intentions"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Мотивации" 
                                                items={isEditingProfile ? editedProfile.motivations : userProfile.motivations} 
                                                color="#10b981" 
                                                field="motivations"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Текущие вызовы" 
                                                items={isEditingProfile ? editedProfile.challenges : userProfile.challenges} 
                                                color="#ef4444" 
                                                field="challenges"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Краткосрочные цели" 
                                                items={isEditingProfile ? editedProfile.shortTermGoals : userProfile.shortTermGoals} 
                                                color="#3b82f6" 
                                                field="shortTermGoals"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Долгосрочные цели" 
                                                items={isEditingProfile ? editedProfile.longTermGoals : userProfile.longTermGoals} 
                                                color="#6366f1" 
                                                field="longTermGoals"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Другое" 
                                                items={isEditingProfile ? editedProfile.goalsOther : userProfile.goalsOther} 
                                                color="#6b7280" 
                                                field="goalsOther"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                        </div>
                                    )}

                                    {activeProfileTab === 'social' && (
                                        <div className="profile-tab-content">
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Семейное положение</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.relationshipStatus}
                                                        onChange={(e) => updateProfileField('relationshipStatus', e.target.value)}
                                                        placeholder="Например: Холост, В отношениях, Женат"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.relationshipStatus}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Семья</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.family}
                                                        onChange={(e) => updateProfileField('family', e.target.value)}
                                                        placeholder="Например: Без детей, Есть дети"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.family}
                                                    </div>
                                                )}
                                            </div>
                                            <ProfileSection 
                                                title="Социальные предпочтения" 
                                                items={isEditingProfile ? editedProfile.socialPreferences : userProfile.socialPreferences} 
                                                color="#3b82f6" 
                                                field="socialPreferences"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Другое" 
                                                items={isEditingProfile ? editedProfile.socialOther : userProfile.socialOther} 
                                                color="#6b7280" 
                                                field="socialOther"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                        </div>
                                    )}

                                    {activeProfileTab === 'health' && (
                                        <div className="profile-tab-content">
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Уровень стресса</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.stressLevel}
                                                        onChange={(e) => updateProfileField('stressLevel', e.target.value)}
                                                        placeholder="Например: Низкий, Средний, Высокий"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.stressLevel}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="mb-5">
                                                <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Уровень энергии</h3>
                                                {isEditingProfile ? (
                                                    <input
                                                        type="text"
                                                        value={editedProfile.energyLevel}
                                                        onChange={(e) => updateProfileField('energyLevel', e.target.value)}
                                                        placeholder="Например: Низкий, Средний, Высокий"
                                                        className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:border-gray-900"
                                                    />
                                                ) : (
                                                    <div className="text-sm text-gray-700 bg-gray-50 px-3 py-1.5 rounded-md inline-block border border-gray-200">
                                                        {userProfile.energyLevel}
                                                    </div>
                                                )}
                                            </div>
                                            <ProfileSection 
                                                title="Цели по здоровью" 
                                                items={isEditingProfile ? editedProfile.healthGoals : userProfile.healthGoals} 
                                                color="#10b981" 
                                                field="healthGoals"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Пищевые предпочтения" 
                                                items={isEditingProfile ? editedProfile.dietaryPreferences : userProfile.dietaryPreferences} 
                                                color="#f59e0b" 
                                                field="dietaryPreferences"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Привычки по физической активности" 
                                                items={isEditingProfile ? editedProfile.exerciseHabits : userProfile.exerciseHabits} 
                                                color="#3b82f6" 
                                                field="exerciseHabits"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                            <ProfileSection 
                                                title="Другое" 
                                                items={isEditingProfile ? editedProfile.healthOther : userProfile.healthOther} 
                                                color="#6b7280" 
                                                field="healthOther"
                                                isEditing={isEditingProfile}
                                                newItemInput={newItemInput}
                                                updateNewItemInput={updateNewItemInput}
                                                addItemToProfileArray={addItemToProfileArray}
                                                removeItemFromProfileArray={removeItemFromProfileArray}
                                            />
                                        </div>
                                    )}
                                </div>

                                {/* Футер */}
                                <div className="p-3 md:p-4 border-t border-gray-200 space-y-2">
                                    <p className="text-xs text-gray-400 text-center">
                                        Автообновление профиля
                                    </p>
                                    <button
                                        onClick={handleLogout}
                                        className="w-full py-2 px-3 bg-gray-50 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-100 transition-colors"
                                    >
                                        Выйти
                                    </button>
                                    <button
                                        onClick={handleDeleteAccount}
                                        className="w-full py-2 px-3 text-red-600 rounded-lg text-xs font-medium hover:bg-red-50 transition-colors"
                                    >
                                        Удалить аккаунт
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Основная область чата */}
                    <div className="flex-1 flex flex-col">
                        {/* Верхняя панель с выбором модели */}
                        <div className="border-b border-gray-200 px-3 md:px-6 py-3 flex items-center justify-between">
                            <div className="flex items-center space-x-2 md:space-x-3">
                                {/* Кнопка меню для мобильных */}
                                <button
                                    onClick={() => setIsMobileSidebarOpen(true)}
                                    className="md:hidden p-2 -ml-2 text-gray-600 hover:text-gray-800 active:bg-gray-100 rounded-lg"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </button>
                                <span className="text-xs md:text-sm text-gray-500 hidden sm:inline">Модель:</span>
                                <select
                                    value={activeTab?.model}
                                    onChange={(e) => changeModel(e.target.value)}
                                    className="model-select text-xs md:text-sm border border-gray-300 rounded-lg px-2 md:px-3 py-1.5 text-gray-700 focus:border-gray-400 transition-colors"
                                    disabled={isLoadingModels}
                                >
                                    {isLoadingModels ? (
                                        <option>Загрузка...</option>
                                    ) : (
                                        models.map(model => (
                                            <option key={model.id} value={model.id}>
                                                {model.name}
                                            </option>
                                        ))
                                    )}
                                </select>
                            </div>
                            
                            {/* Баланс токенов */}
                            <div>
                                <span className="token-badge" style={{ padding: '4px 10px', fontSize: '11px', gap: '4px' }}>
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span className="hidden sm:inline">{tokenBalance.toLocaleString()}</span>
                                    <span className="sm:hidden">{tokenBalance >= 1000 ? (tokenBalance / 1000).toFixed(1) + 'k' : tokenBalance}</span>
                                </span>
                            </div>
                        </div>

                        {/* Область сообщений */}
                        <div className="flex-1 overflow-y-auto chat-messages">
                            {!activeTab ? (
                                <div className="h-full flex items-center justify-center">
                                    <div className="text-center">
                                        <p className="text-gray-400 text-base mb-4">Выберите чат или создайте новый</p>
                                        <button
                                            onClick={addNewTab}
                                            className="px-4 py-2 bg-gray-900 text-white rounded-lg text-sm hover:bg-gray-800 transition-colors"
                                        >
                                            + Создать чат
                                        </button>
                                    </div>
                                </div>
                            ) : activeTab.messages.length === 0 ? (
                                <div className="h-full flex items-center justify-center">
                                    <div className="text-center">
                                        <p className="text-gray-400 text-sm">Начните новый разговор</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="max-w-3xl mx-auto py-4 md:py-8 px-3 md:px-6">
                                    {activeTab.messages.map((message, index) => (
                                        <div
                                            key={index}
                                            className={`message-animate mb-6 md:mb-8 ${
                                                message.role === 'user' 
                                                    ? 'flex justify-end' 
                                                    : ''
                                            }`}
                                        >
                                            <div className={`max-w-[90%] md:max-w-[85%] ${
                                                message.role === 'user'
                                                    ? 'bg-gray-100 rounded-2xl px-3 md:px-4 py-2.5 md:py-3'
                                                    : ''
                                            }`}>
                                                <div className={`text-xs font-semibold mb-2 ${
                                                    message.role === 'user' 
                                                        ? 'text-gray-600' 
                                                        : 'text-gray-500'
                                                }`}>
                                                    {message.role === 'user' ? 'Вы' : (message.modelName || models.find(m => m.id === activeTab.model)?.name)}
                                                </div>
                                                {message.isTyping ? (
                                                    <div className="typing-indicator">
                                                        <div className="typing-dot"></div>
                                                        <div className="typing-dot"></div>
                                                        <div className="typing-dot"></div>
                                                    </div>
                                                ) : (
                                                    <div 
                                                        className="text-gray-800 text-sm leading-relaxed markdown-content"
                                                        dangerouslySetInnerHTML={{ __html: marked.parse(message.content || '') }}
                                                    />
                                                )}
                                                {message.files && message.files.length > 0 && (
                                                    <div className="mt-3 space-y-2">
                                                        {message.files.map((file, fileIndex) => (
                                                            <div key={fileIndex} className="bg-white border border-gray-200 rounded-lg p-2 text-xs">
                                                                {file.isAudio ? (
                                                                    <div>
                                                                        <div className="flex items-center space-x-2 mb-1">
                                                                            <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                                                            </svg>
                                                                            <span className="text-gray-700">{file.name}</span>
                                                                        </div>
                                                                        <audio controls className="w-full mt-1" style={{ height: '32px' }}>
                                                                            <source src={file.url} type={file.type} />
                                                                        </audio>
                                                                    </div>
                                                                ) : file.type.startsWith('image/') ? (
                                                                    <div>
                                                                        <img src={file.url} alt={file.name} className="max-w-full rounded mb-1" style={{ maxHeight: '200px' }} />
                                                                        <div className="text-gray-600">{file.name}</div>
                                                                    </div>
                                                                ) : (
                                                                    <div className="flex items-center space-x-2">
                                                                        <svg className="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                                        </svg>
                                                                        <div>
                                                                            <div className="text-gray-700">{file.name}</div>
                                                                            <div className="text-gray-400">{(file.size / 1024).toFixed(1)} KB</div>
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>
                            )}
                        </div>

                        {/* Поле ввода */}
                        <div className="border-t border-gray-200 p-3 md:p-4">
                            <div className="max-w-3xl mx-auto">
                                {/* Прикрепленные файлы */}
                                {attachedFiles.length > 0 && (
                                    <div className="mb-2 md:mb-3 flex flex-wrap gap-2">
                                        {attachedFiles.map((file, index) => (
                                            <div key={index} className="bg-gray-100 rounded-lg px-2.5 md:px-3 py-1.5 md:py-2 text-xs flex items-center space-x-2">
                                                {file.isAudio ? (
                                                    <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                                    </svg>
                                                ) : file.type.startsWith('image/') ? (
                                                    <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                ) : (
                                                    <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                                    </svg>
                                                )}
                                                <span className="text-gray-700 max-w-[100px] md:max-w-[150px] truncate">{file.name}</span>
                                                <button
                                                    onClick={() => removeFile(index)}
                                                    className="text-gray-400 hover:text-gray-600"
                                                >
                                                    ✕
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <div className="flex items-end space-x-1.5 md:space-x-2 bg-white border border-gray-300 rounded-2xl px-2.5 md:px-4 py-2.5 md:py-3 focus-within:border-gray-400 transition-colors">
                                    {/* Кнопка прикрепления файлов */}
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        disabled={!activeTab}
                                        className="flex-shrink-0 p-1.5 md:p-2 text-gray-500 hover:text-gray-700 active:bg-gray-100 md:hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                                        title="Прикрепить файл"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                        </svg>
                                    </button>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        multiple
                                        onChange={handleFileSelect}
                                        className="file-input"
                                    />
                                    
                                    {/* Кнопка записи голоса */}
                                    <button
                                        onClick={toggleRecording}
                                        disabled={!activeTab}
                                        className={`flex-shrink-0 p-1.5 md:p-2 rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed ${
                                            isRecording
                                                ? 'bg-red-500 text-white recording-pulse'
                                                : 'text-gray-500 hover:text-gray-700 active:bg-gray-100 md:hover:bg-gray-100'
                                        }`}
                                        title={isRecording ? 'Остановить запись' : 'Записать голосовое сообщение'}
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                        </svg>
                                    </button>
                                    
                                    <textarea
                                        ref={textareaRef}
                                        value={input}
                                        onChange={handleInputChange}
                                        onKeyDown={handleKeyDown}
                                        placeholder={activeTab ? "Напишите сообщение..." : "Выберите или создайте чат"}
                                        rows="1"
                                        disabled={!activeTab}
                                        className="flex-1 resize-none text-sm text-gray-800 placeholder-gray-400 bg-transparent overflow-hidden disabled:cursor-not-allowed"
                                        style={{ minHeight: '24px', maxHeight: '200px' }}
                                    />
                                    
                                    {/* Кнопка отправки */}
                                    <button
                                        onClick={sendMessage}
                                        disabled={!activeTab || (!input.trim() && attachedFiles.length === 0)}
                                        className={`flex-shrink-0 p-1.5 md:p-2 rounded-lg transition-colors ${
                                            activeTab && (input.trim() || attachedFiles.length > 0)
                                                ? 'bg-gray-800 active:bg-black md:hover:bg-gray-900 text-white cursor-pointer'
                                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                        }`}
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                        </svg>
                                    </button>
                                </div>
                                <p className="text-xs text-gray-400 text-center mt-2 md:mt-3 hidden sm:block">
                                    Enter для отправки, Shift+Enter для новой строки
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Модальное окно подтверждения удаления */}
                    {deleteConfirmModal.isOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4">
                            <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6 animate-fadeIn">
                                <h3 className="text-lg font-semibold text-gray-800 mb-3">
                                    Удалить чат?
                                </h3>
                                <p className="text-sm text-gray-600 mb-1">
                                    Вы действительно хотите удалить чат
                                </p>
                                <p className="text-sm font-medium text-gray-800 mb-6">
                                    "{deleteConfirmModal.chatName}"?
                                </p>
                                <p className="text-xs text-gray-500 mb-6">
                                    Это действие нельзя будет отменить. Все сообщения в этом чате будут удалены.
                                </p>
                                <div className="flex space-x-3">
                                    <button
                                        onClick={cancelDeleteChat}
                                        disabled={isDeletingChat}
                                        className="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 active:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        onClick={confirmDeleteChat}
                                        disabled={isDeletingChat}
                                        className="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 active:bg-red-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                                    >
                                        {isDeletingChat ? (
                                            <>
                                                <div className="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                                                Удаление...
                                            </>
                                        ) : (
                                            'Удалить'
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
